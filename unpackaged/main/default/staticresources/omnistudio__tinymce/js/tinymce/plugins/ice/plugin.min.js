!function(){tinymce.create("tinymce.plugins.IcePlugin",{deleteTag:"span",insertTag:"span",deleteClass:"del",insertClass:"ins",changeIdAttribute:"data-cid",userIdAttribute:"data-userid",userNameAttribute:"data-username",timeAttribute:"data-time",preserveOnPaste:"p",user:{name:"Unknown User",id:Math.random()},isTracking:!0,contentEditable:!0,css:"css/ice.css",manualInit:!1,scriptVersion:(new Date).getTime(),afterInit:function(){},afterClean:function(e){return e},beforePasteClean:function(e){return e},afterPasteClean:function(e){return e},trackChangesButton:function(){},showChangesButton:function(){},acceptButton:function(){},rejectButton:function(){},acceptAllButton:function(){},rejectAllButton:function(){},init:function(e,t){function n(t){return!!e.dom.getParent(t,a.insertSelector+","+a.deleteSelector)}function i(){var t=e.dom.select(a.insertSelector+":empty,"+a.deleteSelector+":empty");e.dom.remove(t)}var a=this,c=null;e.on("keydown",function(e){46!=e.keyCode&&8!=e.keyCode||!a.isTracking||"mozilla"==ice.dom.browser().type||e.preventDefault()}),e.on("init",function(n){var i=e.dom;tinymce.extend(a,e.getParam("ice")),a.insertSelector="."+a.insertClass,a.deleteSelector="."+a.deleteClass,e.serializer.addRules(a.insertTag+"[id|class|title|style|"+a.changeIdAttribute+"|"+a.userIdAttribute+"|"+a.userNameAttribute+"|"+a.timeAttribute+"]"),e.serializer.addRules(a.deleteTag+"[id|class|title|style|"+a.changeIdAttribute+"|"+a.userIdAttribute+"|"+a.userNameAttribute+"|"+a.timeAttribute+"]"),e.serializer.addRules("tempdel[data-allocation]"),i.loadCSS(a.css.indexOf("://")>0?a.css:t+"/"+a.css);var c=function(){var t={};t.skip_focus=!0,a.manualInit||e.execCommand("initializeice",!1,null,t)},o=document.createElement("script");o.type="text/javascript",o.readyState?o.onreadystatechange=function(){c()}:o.onload=c,o.src=t+"/js/ice.js?version="+a.scriptVersion,document.getElementsByTagName("head")[0].appendChild(o)}),e.addCommand("initializeice",function(t){e=t||e,tinymce.DOM.win.setTimeout(function(){c=new ice.InlineChangeEditor({element:e.getBody(),isTracking:a.isTracking,contentEditable:a.contentEditable,changeIdAttribute:a.changeIdAttribute,userIdAttribute:a.userIdAttribute,userNameAttribute:a.userNameAttribute,timeAttribute:a.timeAttribute,currentUser:{id:a.user.id,name:a.user.name},plugins:["IceEmdashPlugin","IceAddTitlePlugin","IceSmartQuotesPlugin",{name:"IceCopyPastePlugin",settings:{pasteType:"formattedClean",preserve:a.preserveOnPaste,beforePasteClean:a.beforePasteClean,afterPasteClean:a.afterPasteClean}}],changeTypes:{insertType:{tag:a.insertTag,alias:a.insertClass},deleteType:{tag:a.deleteTag,alias:a.deleteClass}}}).startTracking(),e.on("mousedown",function(e){return c.handleEvent(e)}),e.on("keyup",function(e){return console.log("In ice keyup"),c.handleEvent(e)}),e.on("keydown",function(e){return console.log("In ice keydown: "+String.fromCharCode(e.which)),c.handleEvent(e)}),e.on("keypress",function(e){return c.handleEvent(e)}),setTimeout(function(){a.afterInit.call(a)},10)},500)}),e.addCommand("ice_initenv",function(){c.initializeEnvironment(),c.initializeRange()}),e.addCommand("icecleanbody",function(t){var n=c.getCleanContent(t||e.getContent(),a.afterClean,a.beforeClean);return n}),e.addCommand("ice_hasDeletePlaceholders",function(){return c.isPlaceholdingDeletes}),e.addCommand("ice_addDeletePlaceholders",function(){return c.placeholdDeletes()}),e.addCommand("ice_removeDeletePlaceholders",function(){return c.revertDeletePlaceholders()}),e.addCommand("iceinsert",function(e){e=e||{},c.insert(e.item,e.range)}),e.addCommand("icedelete",function(e){e=e||{},c.deleteContents(e.right,e.range)}),e.addCommand("ice_changeuser",function(e){c.setCurrentUser(e)}),e.addCommand("iceaccept",function(t){e.undoManager.add(),c.acceptChange(t||e.selection.getNode()),i()}),e.addCommand("icereject",function(t){e.undoManager.add(),c.rejectChange(t||e.selection.getNode()),i()}),e.addCommand("iceacceptall",function(){e.undoManager.add(),c.acceptAll(),i()}),e.addCommand("icerejectall",function(){e.undoManager.add(),c.rejectAll(),i()}),e.addCommand("ice_toggleshowchanges",function(){var t=e.getBody(),n=(e.controlManager,!0);e.dom.hasClass(t,"CT-hide")?(e.plugins.ice.showChangesButton.active(!0),e.dom.removeClass(t,"CT-hide"),n=!1):(e.plugins.ice.showChangesButton.active(!1),e.dom.addClass(t,"CT-hide")),e.plugins.ice.acceptAllButton.disabled(n),e.plugins.ice.rejectAllButton.disabled(n),e.plugins.ice.acceptButton.disabled(n),e.plugins.ice.rejectButton.disabled(n),e.execCommand("mceRepaint")}),e.addCommand("ice_smartquotes",function(t){c.pluginsManager.plugins.IceSmartQuotesPlugin.convert(e.getBody()),t||e.windowManager.alert("Regular quotes have been converted into smart quotes.")}),e.addCommand("ice_togglechanges",function(){c.isTracking?e.execCommand("ice_disable"):e.execCommand("ice_enable")}),e.addCommand("ice_enable",function(){c.enableChangeTracking(),e.plugins.ice.trackChangesButton.active(!0),e.plugins.ice.showChangesButton.disabled(!1),e.execCommand("ice_toggleshowchanges"),a.isTracking=!0}),e.addCommand("ice_disable",function(){var t=e.getBody();e.dom.addClass(t,"CT-hide"),e.plugins.ice.trackChangesButton.active(!1),e.plugins.ice.showChangesButton.active(!1),e.plugins.ice.showChangesButton.disabled(!0),e.plugins.ice.acceptAllButton.disabled(!0),e.plugins.ice.rejectAllButton.disabled(!0),e.plugins.ice.acceptButton.disabled(!0),e.plugins.ice.rejectButton.disabled(!0),c.disableChangeTracking(),a.isTracking=!1}),e.addCommand("ice_isTracking",function(){return c.isTracking?1:0}),e.addCommand("ice_strippaste",function(e){return c.pluginsManager.plugins.IceCopyPastePlugin.stripPaste(e)}),e.addCommand("ice_handlepaste",function(e){return c.pluginsManager.plugins.IceCopyPastePlugin.handlePaste()}),e.addCommand("ice_handleemdash",function(e){return c.pluginsManager.plugins.IceEmdashPlugin.convertEmdash()?1:0}),e.addButton("iceaccept",{title:"Accept Redline",image:t+"/img/accept.png",cmd:"iceaccept",onPostRender:function(){var t=this;e.plugins.ice.acceptButton=t,e.plugins.ice.acceptButton.disabled=t.disabled,e.on("NodeChange",function(e){n(e.element)?t.disabled(!1):t.disabled(!0)})}}),e.addButton("icereject",{title:"Reject Redline",image:t+"/img/reject.png",cmd:"icereject",onPostRender:function(){var t=this;e.plugins.ice.rejectButton=t,e.plugins.ice.rejectButton.disabled=t.disabled,e.on("NodeChange",function(e){n(e.element)?t.disabled(!1):t.disabled(!0)})}}),e.addButton("iceacceptall",{title:"Accept All Redlines",image:t+"/img/accept_all.png",cmd:"iceacceptall",onPostRender:function(){var t=this;e.plugins.ice.acceptAllButton=t,e.plugins.ice.acceptAllButton.disabled=t.disabled}}),e.addButton("icerejectall",{title:"Reject All Redlines",image:t+"/img/reject_all.png",cmd:"icerejectall",onPostRender:function(){var t=this;e.plugins.ice.rejectAllButton=t,e.plugins.ice.rejectAllButton.disabled=t.disabled}}),e.addButton("ice_toggleshowchanges",{title:"Show or Hide Redlines",image:t+"/img/show_or_hide.png",onclick:function(){e.fire("ice_toggleshowchanges"),e.execCommand("ice_toggleshowchanges")},onPostRender:function(){var t=this;e.plugins.ice.showChangesButton=t,e.plugins.ice.showChangesButton.disabled=t.disabled,e.plugins.ice.showChangesButton.active=t.active}}),e.addButton("ice_smartquotes",{title:"Convert quotes to smart quotes","class":"mce_blockquote",cmd:"ice_smartquotes"}),e.addButton("ice_togglechanges",{title:"Turn On Track Changes ",image:t+"/img/ice-togglechanges.png",cmd:"ice_togglechanges",onPostRender:function(){var t=this;e.plugins.ice.trackChangesButton=t,e.plugins.ice.trackChangesButton.disabled=t.disabled,e.plugins.ice.trackChangesButton.active=t.active}}),e.addMenuItem("iceaccept",{icon:"accept",text:"Accept Change",onclick:function(){e.execCommand("iceaccept")},context:"tools",prependToContext:!0}),e.addMenuItem("icereject",{icon:"reject",text:"Reject Change",onclick:function(){e.execCommand("icereject")},context:"tools",prependToContext:!0}),e.on("NodeChange",function(e){i()})}}),tinymce.PluginManager.add("ice",tinymce.plugins.IcePlugin)}();