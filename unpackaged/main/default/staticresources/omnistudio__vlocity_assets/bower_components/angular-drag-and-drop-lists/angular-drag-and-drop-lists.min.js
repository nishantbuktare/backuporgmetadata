angular.module("dndLists",[]).directive("dndDraggable",["$parse","$timeout","dndDropEffectWorkaround","dndDragTypeWorkaround",function(e,r,n,t){return function(a,d,o){d.attr("draggable","true"),o.dndDisableIf&&a.$watch(o.dndDisableIf,function(e){d.attr("draggable",!e)}),d.on("dragstart",function(i){var f=i.originalEvent||i;f.dataTransfer.setData("Text",angular.toJson(a.$eval(o.dndDraggable))),f.dataTransfer.effectAllowed=o.dndEffectAllowed||"move",d.addClass("dndDragging"),r(function(){d.addClass("dndDraggingSource")},0),n.dropEffect="none",t.isDragging=!0,t.dragType=o.dndType?a.$eval(o.dndType):void 0,e(o.dndDragstart)(a,{event:f}),f.stopPropagation()}),d.on("dragend",function(i){var f=i.originalEvent||i,s=n.dropEffect;a.$apply(function(){switch(s){case"move":e(o.dndMoved)(a,{event:f});break;case"copy":e(o.dndCopied)(a,{event:f});break;case"none":e(o.dndCanceled)(a,{event:f})}e(o.dndDragend)(a,{event:f,dropEffect:s})}),d.removeClass("dndDragging"),r(function(){d.removeClass("dndDraggingSource")},0),t.isDragging=!1,f.stopPropagation()}),d.on("click",function(r){if(o.dndSelected){var n=r.originalEvent||r;a.$apply(function(){e(o.dndSelected)(a,{event:n})}),n.stopPropagation()}}),d.on("selectstart",function(){this.dragDrop&&this.dragDrop()})}}]).directive("dndList",["$parse","$timeout","dndDropEffectWorkaround","dndDragTypeWorkaround",function(e,r,n,t){return function(r,a,d){function o(e,r){"use strict";for(var n,t,a,d=0,o=e.length-1;o>=d;)if(n=(d+o)/2|0,t=e[n],a=f(r,t,!0))d=n+1;else{if(t===D)return n;o=n-1}return-1}function i(e){for(var r=e.target.offsetParent,n=0,t=0;r&&!isNaN(r.offsetLeft)&&!isNaN(r.offsetTop);)n+=r.offsetLeft-r.scrollLeft,t+=r.offsetTop-r.scrollTop,r=r.offsetParent;return n=e.clientX-n,t=e.clientY-t,{x:n,y:t}}function f(e,r,n){var t,a,d=0;if(y)t=e.x,a=r.offsetWidth,n&&(d=r.offsetLeft);else{t=e.y;var o=r.getAttribute("data-dnd-height");a=o||r.offsetHeight,n&&(d=r.offsetTop)}return d+a/2>t}function s(){var e;return angular.forEach(a.children(),function(r){var n=angular.element(r);n.hasClass("dndPlaceholder")&&(e=n)}),e||angular.element("<li class='dndPlaceholder'></li>")}function l(){for(var e=Array.prototype.indexOf.call(T.children,D),r=0;r<T.children.length;r++)if(/dndDraggingSource/.test(T.children[r].className)&&e>r)return e-1;return e}function g(e){if(!t.isDragging&&!h)return!1;if(!p(e.dataTransfer.types))return!1;if(d.dndAllowedTypes&&t.isDragging){var n=r.$eval(d.dndAllowedTypes);if(angular.isArray(n)&&-1===n.indexOf(t.dragType))return!1}return d.dndDisableIf&&r.$eval(d.dndDisableIf)?!1:!0}function c(){return v.remove(),a.removeClass("dndDragover"),!0}function u(n,a,d,o){return e(n)(r,{event:a,index:d,item:o||void 0,external:!t.isDragging,type:t.isDragging?t.dragType:void 0})}function p(e){if(!e)return!0;for(var r=0;r<e.length;r++)if("Text"===e[r]||"text/plain"===e[r])return!0;return!1}var v=s(),D=v[0],T=a[0];v.remove();var y=d.dndHorizontalList&&r.$eval(d.dndHorizontalList),h=d.dndExternalSources&&r.$eval(d.dndExternalSources);a.on("dragover",function(e){var r=e.originalEvent||e,n=i(r);if(!g(r))return!0;if(D.parentNode!=T&&a.append(v),r.target!==T)for(var t=r.target;t.parentNode!==T&&t.parentNode;)t=t.parentNode;else{var s=T.children,p=o(s,n);T.insertBefore(D,-1==p?null:s[p])}return t&&t.parentNode===T&&t!==D&&(f(n,t)?T.insertBefore(D,t):T.insertBefore(D,t.nextElementSibling)),d.dndDragover&&!u(d.dndDragover,r,l())?c():(a.addClass("dndDragover"),r.preventDefault(),r.stopPropagation(),!1)}),a.on("drop",function(e){var t=e.originalEvent||e;if(!g(t))return!0;t.preventDefault();var a,o=t.dataTransfer.getData("Text")||t.dataTransfer.getData("text/plain");try{a=JSON.parse(o)}catch(i){return c()}var f=l();if(d.dndDrop&&(a=u(d.dndDrop,t,f,a),!a))return c();var s=r.$eval(d.dndList);return r.$apply(function(){s.splice(f,0,a)}),u(d.dndInserted,t,f,a),"none"===t.dataTransfer.dropEffect?"copy"===t.dataTransfer.effectAllowed||"move"===t.dataTransfer.effectAllowed?n.dropEffect=t.dataTransfer.effectAllowed:n.dropEffect=t.ctrlKey?"copy":"move":n.dropEffect=t.dataTransfer.dropEffect,c(),t.stopPropagation(),!1}),a.on("dragleave",function(e){a.removeClass("dndDragover"),setTimeout(function(){a.hasClass("dndDragover")||v.remove()},250)})}}]).directive("dndNodrag",function(){return function(e,r,n){r.attr("draggable","true"),r.on("dragstart",function(e){var r=e.originalEvent||e;r.dataTransfer.types&&r.dataTransfer.types.length||r.preventDefault(),r.stopPropagation()}),r.on("dragend",function(e){var r=e.originalEvent||e;r.stopPropagation()})}}).factory("dndDragTypeWorkaround",function(){return{}}).factory("dndDropEffectWorkaround",function(){return{}});