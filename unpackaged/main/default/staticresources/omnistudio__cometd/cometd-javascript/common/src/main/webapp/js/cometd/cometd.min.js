/*
 * Copyright (c) 2008-2017 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* CometD Version ${project.version} */
!function(e,t){"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define([],t):(e.org=e.org||{},e.org.cometd=t())}(this,function(){var e={isString:function(e){return void 0!==e&&null!==e&&("string"==typeof e||e instanceof String)},isArray:function(e){return void 0!==e&&null!==e&&e instanceof Array},inArray:function(e,t){for(var n=0;n<t.length;++n)if(e===t[n])return n;return-1},setTimeout:function(e,t,n){return window.setTimeout(function(){try{e._debug("Invoking timed function",t),t()}catch(n){e._debug("Exception invoking timed function",t,n)}},n)},clearTimeout:function(e){window.clearTimeout(e)}},t=function(){var t,n,i;this.registered=function(e,i){t=e,n=i},this.unregistered=function(){t=null,n=null},this._debug=function(){n._debug.apply(n,arguments)},this._mixin=function(){return n._mixin.apply(n,arguments)},this.getConfiguration=function(){return n.getConfiguration()},this.getAdvice=function(){return n.getAdvice()},this.setTimeout=function(t,i){return e.setTimeout(n,t,i)},this.clearTimeout=function(t){e.clearTimeout(t)},this.convertToMessages=function(t){if(e.isString(t))try{return JSON.parse(t)}catch(e){throw this._debug("Could not convert to JSON the following string",'"'+t+'"'),e}if(e.isArray(t))return t;if(void 0===t||null===t)return[];if(t instanceof Object)return[t];throw"Conversion Error "+t+", typeof "+typeof t},this.accept=function(e,t,n){throw"Abstract"},this.getType=function(){return t},this.getURL=function(){return i},this.setURL=function(e){i=e},this.send=function(e,t){throw"Abstract"},this.reset=function(e){this._debug("Transport",t,"reset",e?"initial":"retry")},this.abort=function(){this._debug("Transport",t,"aborted")},this.toString=function(){return this.getType()}};t.derive=function(e){function t(){}return t.prototype=e,new t};var n=function(){var n=new t,i=t.derive(n),r=0,o=null,s=[],a=[];function c(e,t){if(this.transportSend(e,t),t.expired=!1,!e.sync){var n=this.getConfiguration().maxNetworkDelay,i=n;!0===t.metaConnect&&(i+=this.getAdvice().timeout),this._debug("Transport",this.getType(),"waiting at most",i,"ms for the response, maxNetworkDelay",n);var r=this;t.timeout=this.setTimeout(function(){t.expired=!0;var n="Request "+t.id+" of transport "+r.getType()+" exceeded "+i+" ms max network delay",o={reason:n},s=t.xhr;o.httpCode=r.xhrStatus(s),r.abortXHR(s),r._debug(n),r.complete(t,!1,t.metaConnect),e.onFailure(s,e.messages,o)},i)}}function u(e){var t=++r,n={id:t,metaConnect:!1,envelope:e};s.length<this.getConfiguration().maxConnections-1?(s.push(n),c.call(this,e,n)):(this._debug("Transport",this.getType(),"queueing request",t,"envelope",e),a.push([e,n]))}function l(t,n){var i=e.inArray(t,s);if(i>=0&&s.splice(i,1),a.length>0){var r=a.shift(),o=r[0],c=r[1];if(this._debug("Transport dequeued request",c.id),n)this.getConfiguration().autoBatch&&function(e){for(;a.length>0;){var t=a[0],n=t[0],i=t[1];if(n.url!==e.url||n.sync!==e.sync)break;a.shift(),e.messages=e.messages.concat(n.messages),this._debug("Coalesced",n.messages.length,"messages from request",i.id)}}.call(this,o),u.call(this,o),this._debug("Transport completed request",t.id,o);else{var l=this;this.setTimeout(function(){l.complete(c,!1,c.metaConnect);var e={reason:"Previous request failed"},t=c.xhr;e.httpCode=l.xhrStatus(t),o.onFailure(t,o.messages,e)},0)}}}return i.complete=function(e,t,n){n?function(e){var t=e.id;if(this._debug("Transport",this.getType(),"metaConnect complete, request",t),null!==o&&o.id!==t)throw"Longpoll request mismatch, completing request "+t;o=null}.call(this,e):l.call(this,e,t)},i.transportSend=function(e,t){throw"Abstract"},i.transportSuccess=function(e,t,n){t.expired||(this.clearTimeout(t.timeout),this.complete(t,!0,t.metaConnect),n&&n.length>0?e.onSuccess(n):e.onFailure(t.xhr,e.messages,{httpCode:204}))},i.transportFailure=function(e,t,n){t.expired||(this.clearTimeout(t.timeout),this.complete(t,!1,t.metaConnect),e.onFailure(t.xhr,e.messages,n))},i.send=function(e,t){t?function(e){if(null!==o)throw"Concurrent metaConnect requests not allowed, request id="+o.id+" not yet completed";var t=++r;this._debug("Transport",this.getType(),"metaConnect send, request",t,"envelope",e);var n={id:t,metaConnect:!0,envelope:e};c.call(this,e,n),o=n}.call(this,e):u.call(this,e)},i.abort=function(){n.abort();for(var e=0;e<s.length;++e){var t=s[e];t&&(this._debug("Aborting request",t),this.abortXHR(t.xhr)||this.transportFailure(t.envelope,t,{reason:"abort"}))}var i=o;i&&(this._debug("Aborting metaConnect request",i),this.abortXHR(i.xhr)||this.transportFailure(i.envelope,i,{reason:"abort"})),this.reset(!0)},i.reset=function(e){n.reset(e),o=null,s=[],a=[]},i.abortXHR=function(e){if(e)try{var t=e.readyState;return e.abort(),t!==XMLHttpRequest.UNSENT}catch(e){this._debug(e)}return!1},i.xhrStatus=function(e){if(e)try{return e.status}catch(e){this._debug(e)}return-1},i},i=function(){var e=new n,i=t.derive(e),r=!0;return i.accept=function(e,t,n){return r||!t},i.xhrSend=function(e){var t=new XMLHttpRequest;t.withCredentials=!0,t.open("POST",e.url,!0!==e.sync);var n=e.headers;if(n)for(var i in n)n.hasOwnProperty(i)&&t.setRequestHeader(i,n[i]);return t.setRequestHeader("Content-Type","application/json;charset=UTF-8"),t.onload=function(){200===t.status?e.onSuccess(t.responseText):e.onError(t.statusText)},t.onerror=function(){e.onError(t.statusText)},t.send(e.body),t},i.transportSend=function(e,t){this._debug("Transport",this.getType(),"sending request",t.id,"envelope",e);var n=this;try{var i=!0;t.xhr=this.xhrSend({transport:this,url:e.url,sync:e.sync,headers:this.getConfiguration().requestHeaders,body:JSON.stringify(e.messages),onSuccess:function(i){n._debug("Transport",n.getType(),"received response",i);var o=!1;try{var s=n.convertToMessages(i);0===s.length?(r=!1,n.transportFailure(e,t,{httpCode:204})):(o=!0,n.transportSuccess(e,t,s))}catch(i){if(n._debug(i),!o){r=!1;var a={exception:i};a.httpCode=n.xhrStatus(t.xhr),n.transportFailure(e,t,a)}}},onError:function(o,s){n._debug("Transport",n.getType(),"received error",o,s),r=!1;var a={reason:o,exception:s};a.httpCode=n.xhrStatus(t.xhr),i?n.setTimeout(function(){n.transportFailure(e,t,a)},0):n.transportFailure(e,t,a)}}),i=!1}catch(i){r=!1,this.setTimeout(function(){n.transportFailure(e,t,{exception:i})},0)}},i.reset=function(t){e.reset(t),r=!0},i},r=function(){var e=new n,i=t.derive(e),r=0;function o(e,t,n){var i=this;return function(){i.transportFailure(e,t,"error",n)}}return i.accept=function(e,t,n){return!0},i.jsonpSend=function(e){var t=document.getElementsByTagName("head")[0],n=document.createElement("script"),i="_cometd_jsonp_"+r++;window[i]=function(r){t.removeChild(n),delete window[i],e.onSuccess(r)};var o=e.url;o+=o.indexOf("?")<0?"?":"&",o+="jsonp="+i,o+="&message="+e.body,n.src=o,n.async=!0!==e.sync,n.type="application/javascript",n.onerror=function(t){e.onError("jsonp "+t.type)},t.appendChild(n)},i.transportSend=function(e,t){for(var n=this,i=0,r=e.messages.length,s=[];r>0;){var a=JSON.stringify(e.messages.slice(i,i+r)),c=e.url.length+encodeURI(a).length,u=this.getConfiguration().maxURILength;if(c>u){if(1===r){var l="Bayeux message too big ("+c+" bytes, max is "+u+") for transport "+this.getType();return void this.setTimeout(o.call(this,e,t,l),0)}--r}else s.push(r),i+=r,r=e.messages.length-i}var h=e;if(s.length>1){var f=0,d=s[0];this._debug("Transport",this.getType(),"split",e.messages.length,"messages into",s.join(" + ")),(h=this._mixin(!1,{},e)).messages=e.messages.slice(f,d),h.onSuccess=e.onSuccess,h.onFailure=e.onFailure;for(var g=1;g<s.length;++g){var p=this._mixin(!1,{},e);f=d,d+=s[g],p.messages=e.messages.slice(f,d),p.onSuccess=e.onSuccess,p.onFailure=e.onFailure,this.send(p,t.metaConnect)}}this._debug("Transport",this.getType(),"sending request",t.id,"envelope",h);try{var m=!0;this.jsonpSend({transport:this,url:h.url,sync:h.sync,headers:this.getConfiguration().requestHeaders,body:JSON.stringify(h.messages),onSuccess:function(e){var i=!1;try{var r=n.convertToMessages(e);0===r.length?n.transportFailure(h,t,{httpCode:204}):(i=!0,n.transportSuccess(h,t,r))}catch(e){n._debug(e),i||n.transportFailure(h,t,{exception:e})}},onError:function(e,i){var r={reason:e,exception:i};m?n.setTimeout(function(){n.transportFailure(h,t,r)},0):n.transportFailure(h,t,r)}}),m=!1}catch(e){this.setTimeout(function(){n.transportFailure(h,t,{exception:e})},0)}},i},o=function(){var n,i=new t,r=t.derive(i),o=!0,s=!1,a=!0,c=null,u=null,l=!1,h=null;function f(e,t){e&&(this.webSocketClose(e,t.code,t.reason),this.onClose(e,t))}function d(e){return e===u||e===c}function g(e,t,n){for(var i=[],r=0;r<t.messages.length;++r){var o=t.messages[r];o.id&&i.push(o.id)}e.envelopes[i.join(",")]=[t,n],this._debug("Transport",this.getType(),"stored envelope, envelopes",e.envelopes)}function p(e,t,i){var r=JSON.stringify(t.messages);e.webSocket.send(r),this._debug("Transport",this.getType(),"sent",t,"metaConnect =",i);var o=this.getConfiguration().maxNetworkDelay,s=o;i&&(s+=this.getAdvice().timeout,l=!0);for(var a=this,c=[],u=0;u<t.messages.length;++u)!function(){var i=t.messages[u];i.id&&(c.push(i.id),e.timeouts[i.id]=a.setTimeout(function(){n._debug("Transport",a.getType(),"timing out message",i.id,"after",s,"on",e),f.call(a,e,{code:1e3,reason:"Message Timeout"})},s))}();this._debug("Transport",this.getType(),"waiting at most",s,"ms for messages",c,"maxNetworkDelay",o,", timeouts:",e.timeouts)}function m(e,t,i){try{null===e?(e=u||{envelopes:{},timeouts:{}},g.call(this,e,t,i),function(e){if(!u){var t=n.getURL().replace(/^http/,"ws");this._debug("Transport",this.getType(),"connecting to URL",t);try{var i=n.getConfiguration().protocol;e.webSocket=i?new window.WebSocket(t,i):new window.WebSocket(t),u=e}catch(e){throw o=!1,this._debug("Exception while creating WebSocket object",e),e}a=!1!==n.getConfiguration().stickyReconnect;var r=this,l=n.getConfiguration().connectTimeout;l>0&&(e.connectTimer=this.setTimeout(function(){n._debug("Transport",r.getType(),"timed out while connecting to URL",t,":",l,"ms"),f.call(r,e,{code:1e3,reason:"Connect Timeout"})},l));var h=function(t){t=t||{code:1e3},n._debug("WebSocket onclose",e,t,"connecting",u,"current",c),e.connectTimer&&r.clearTimeout(e.connectTimer),r.onClose(e,t)};e.webSocket.onopen=function(){n._debug("WebSocket onopen",e),e.connectTimer&&r.clearTimeout(e.connectTimer),d(e)?(u=null,c=e,s=!0,r.onOpen(e)):(n._warn("Closing extra WebSocket connection",this,"active connection",c),f.call(r,e,{code:1e3,reason:"Extra Connection"}))},e.webSocket.onclose=h,e.webSocket.onerror=function(){h({code:1e3,reason:"Error"})},e.webSocket.onmessage=function(t){n._debug("WebSocket onmessage",t,e),r.onMessage(e,t)},this._debug("Transport",this.getType(),"configured callbacks on",e)}}.call(this,e)):(g.call(this,e,t,i),p.call(this,e,t,i))}catch(t){var r=this;this.setTimeout(function(){f.call(r,e,{code:1e3,reason:"Exception",exception:t})},0)}}return r.reset=function(e){i.reset(e),o=!0,e&&(s=!1),a=!0,c=null,u=null,l=!1},r._notifySuccess=function(e,t){e.call(this,t)},r._notifyFailure=function(e,t,n,i){e.call(this,t,n,i)},r.onOpen=function(e){var t=e.envelopes;this._debug("Transport",this.getType(),"opened",e,"pending messages",t);for(var n in t)if(t.hasOwnProperty(n)){var i=t[n],r=i[0],o=i[1];h=r.onSuccess,p.call(this,e,r,o)}},r.onMessage=function(t,n){this._debug("Transport",this.getType(),"received websocket message",n,t);for(var i=!1,r=this.convertToMessages(n.data),o=[],s=0;s<r.length;++s){var a=r[s];if((/^\/meta\//.test(a.channel)||void 0===a.data)&&a.id){o.push(a.id);var c=t.timeouts[a.id];c&&(this.clearTimeout(c),delete t.timeouts[a.id],this._debug("Transport",this.getType(),"removed timeout for message",a.id,", timeouts",t.timeouts))}"/meta/connect"===a.channel&&(l=!1),"/meta/disconnect"!==a.channel||l||(i=!0)}for(var u=!1,f=t.envelopes,d=0;d<o.length;++d){var g=o[d];for(var p in f)if(f.hasOwnProperty(p)){var m=p.split(","),v=e.inArray(g,m);if(v>=0){u=!0,m.splice(v,1);var b=f[p][0],y=f[p][1];delete f[p],m.length>0&&(f[m.join(",")]=[b,y]);break}}}u&&this._debug("Transport",this.getType(),"removed envelope, envelopes",f),this._notifySuccess(h,r),i&&this.webSocketClose(t,1e3,"Disconnect")},r.onClose=function(e,t){this._debug("Transport",this.getType(),"closed",e,t),d(e)&&(o=a&&s,u=null,c=null);var n=e.timeouts;e.timeouts={};for(var i in n)n.hasOwnProperty(i)&&this.clearTimeout(n[i]);var r=e.envelopes;e.envelopes={};for(var h in r)if(r.hasOwnProperty(h)){var f=r[h][0];r[h][1]&&(l=!1);var g={websocketCode:t.code,reason:t.reason};t.exception&&(g.exception=t.exception),this._notifyFailure(f.onFailure,e,f.messages,g)}},r.registered=function(e,t){i.registered(e,t),n=t},r.accept=function(e,t,i){return this._debug("Transport",this.getType(),"accept, supported:",o),o&&!!window.WebSocket&&!1!==n.websocketEnabled},r.send=function(e,t){this._debug("Transport",this.getType(),"sending",e,"metaConnect =",t),m.call(this,c,e,t)},r.webSocketClose=function(e,t,n){try{e.webSocket&&e.webSocket.close(t,n)}catch(e){this._debug(e)}},r.abort=function(){i.abort(),f.call(this,c,{code:1e3,reason:"Abort"}),this.reset(!0)},r},s=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",".","-",":","+","=","^","!","/","*","?","&","<",">","(",")","[","]","{","}","@","%","$","#"],a=[0,68,0,84,83,82,72,0,75,76,70,65,0,63,62,69,0,1,2,3,4,5,6,7,8,9,64,0,73,66,74,71,81,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,77,0,78,67,0,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,79,0,80,0,0];return{CometD:function(t){var n,s,a,c,u,l=this,h=t||"default",f=!1,d=new function(){var e=[],t={};this.getTransportTypes=function(){return e.slice(0)},this.findTransportTypes=function(n,i,r){for(var o=[],s=0;s<e.length;++s){var a=e[s];!0===t[a].accept(n,i,r)&&o.push(a)}return o},this.negotiateTransport=function(n,i,r,o){for(var s=0;s<e.length;++s)for(var a=e[s],c=0;c<n.length;++c)if(a===n[c]){var u=t[a];if(!0===u.accept(i,r,o))return u}return null},this.add=function(n,i,r){for(var o=!1,s=0;s<e.length;++s)if(e[s]===n){o=!0;break}return o||("number"!=typeof r?e.push(n):e.splice(r,0,n),t[n]=i),!o},this.find=function(n){for(var i=0;i<e.length;++i)if(e[i]===n)return t[n];return null},this.remove=function(n){for(var i=0;i<e.length;++i)if(e[i]===n){e.splice(i,1);var r=t[n];return delete t[n],r}return null},this.clear=function(){e=[],t={}},this.reset=function(n){for(var i=0;i<e.length;++i)t[e[i]].reset(n)}},g="disconnected",p=0,m=null,v=0,b=[],y=!1,T=0,w={},x=0,_=null,k=[],C={},S={},I={},R=!1,L=!1,U=0,E=0,q={protocol:null,stickyReconnect:!0,connectTimeout:0,maxConnections:2,backoffIncrement:1e3,maxBackoff:6e4,logLevel:"info",reverseIncomingExtensions:!0,maxNetworkDelay:1e4,requestHeaders:{},appendMessageTypeToURL:!0,autoBatch:!1,urls:{},maxURILength:2e3,advice:{timeout:6e4,interval:0,reconnect:void 0,maxInterval:0}};function A(e,t){try{return e[t]}catch(e){return}}function F(t){return e.isString(t)}function B(e){return void 0!==e&&null!==e&&"function"==typeof e}function P(e,t){for(var n="";--t>0&&!(e>=Math.pow(10,t));)n+="0";return n+=e}function D(e,t){if(window.console){var n=window.console[e];if(B(n)){var i=new Date;[].splice.call(t,0,0,P(i.getHours(),2)+":"+P(i.getMinutes(),2)+":"+P(i.getSeconds(),2)+"."+P(i.getMilliseconds(),3)),n.apply(window.console,t)}}}function M(e){return/(^https?:\/\/)?(((\[[^\]]+\])|([^:\/\?#]+))(:(\d+))?)?([^\?#]*)(.*)?/.exec(e)}function O(e){if(e){var t=w[e.channel];t&&t[e.id]&&(delete t[e.id],l._debug("Removed",e.listener?"listener":"subscription",e))}}function N(e){e&&!e.listener&&O(e)}function j(){for(var e in w)if(w.hasOwnProperty(e)){var t=w[e];if(t)for(var n in t)t.hasOwnProperty(n)&&N(t[n])}}function H(e){g!==e&&(l._debug("Status",g,"->",e),g=e)}function W(){return"disconnecting"===g||"disconnected"===g}function J(){return""+ ++p}function X(e,t,n,i,r){try{return t.call(e,i)}catch(e){var o=l.onExtensionException;if(B(o)){l._debug("Invoking extension exception handler",n,e);try{o.call(l,e,n,r,i)}catch(e){l._info("Exception during execution of extension exception handler",n,e)}}else l._info("Exception during execution of extension",n,e);return i}}function V(e){for(var t=0;t<k.length&&void 0!==e&&null!==e;++t){var n=k[t],i=n.extension.outgoing;if(B(i)){var r=X(n.extension,i,n.name,e,!0);e=void 0===r?e:r}}return e}function z(e,t){var n=w[e];if(n)for(var i in n)if(n.hasOwnProperty(i)){var r=n[i];if(r)try{r.callback.call(r.scope,t)}catch(e){var o=l.onListenerException;if(B(o)){l._debug("Invoking listener exception handler",r,e);try{o.call(l,e,r,r.listener,t)}catch(e){l._info("Exception during execution of listener exception handler",r,e)}}else l._info("Exception during execution of listener",r,t,e)}}}function Z(e,t){z(e,t);for(var n=e.split("/"),i=n.length-1,r=i;r>0;--r){var o=n.slice(0,r).join("/")+"/*";r===i&&z(o,t),z(o+="*",t)}}function $(){null!==_&&e.clearTimeout(_),_=null}function G(t,n){$();var i=C.interval+n;l._debug("Function scheduled in",i,"ms, interval =",C.interval,"backoff =",x,t),_=e.setTimeout(l,t,i)}function K(e,t,i,r){for(var o=0;o<t.length;++o){var s=t[o],a=s.id;m&&(s.clientId=m),void 0!==(s=V(s))&&null!==s?(s.id=a,t[o]=s):(delete S[a],t.splice(o--,1))}if(0!==t.length){var h=l.getURL();q.appendMessageTypeToURL&&(h.match(/\/$/)||(h+="/"),r&&(h+=r));var f={url:h,sync:e,messages:t,onSuccess:function(e){try{c.call(l,e)}catch(e){l._info("Exception during handling of messages",e)}},onFailure:function(e,t,n){try{var i=l.getTransport();n.connectionType=i?i.getType():"unknown",u.call(l,e,t,n)}catch(e){l._info("Exception during handling of failure",e)}}};l._debug("Send",f),n.send(f,i)}}function Q(e){v>0||!0===y?b.push(e):K(!1,[e],!1)}function Y(){x=0}function ee(){var e=b;b=[],e.length>0&&K(!1,e,!1)}function te(e){H("connecting"),G(function(){!function(){if(!W()){var e={id:J(),channel:"/meta/connect",connectionType:n.getType()};L||(e.advice={timeout:0}),H("connecting"),l._debug("Connect sent",e),K(!1,[e],!0,"connect"),H("connected")}}()},e)}function ne(e){e&&(C=l._mixin(!1,{},q.advice,e),l._debug("New advice",C))}function ie(e){if($(),e&&n&&n.abort(),m=null,H("disconnected"),v=0,Y(),n=null,R=!1,L=!1,b.length>0){var t=b;b=[],u.call(l,void 0,t,{reason:"Disconnected"})}}function re(e,t,n){var i=l.onTransportException;if(B(i)){l._debug("Invoking transport exception handler",e,t,n);try{i.call(l,n,e,t)}catch(e){l._info("Exception during execution of transport exception handler",e)}}}function oe(e,t){B(e)&&(t=e,e=void 0),m=null,j(),W()&&(d.reset(!0),ne(q.advice)),v=0,y=!0,s=e,a=t;var i="1.0",r=l.getURL(),o=d.findTransportTypes(i,f,r),c={id:J(),version:i,minimumVersion:i,channel:"/meta/handshake",supportedConnectionTypes:o,advice:{timeout:C.timeout,interval:C.interval}},u=l._mixin(!1,{},s,c);if(l._putCallback(u.id,t),!n&&!(n=d.negotiateTransport(o,i,f,r))){var h="Could not find initial transport among: "+d.getTransportTypes();throw l._warn(h),h}l._debug("Initial transport is",n.getType()),H("handshaking"),l._debug("Handshake sent",u),K(!1,[u],!1,"handshake")}function se(e,t){try{e.call(l,t)}catch(e){var n=l.onCallbackException;if(B(n)){l._debug("Invoking callback exception handler",e);try{n.call(l,e,t)}catch(e){l._info("Exception during execution of callback exception handler",e)}}else l._info("Exception during execution of message callback",e)}}function ae(e){var t=l._getCallback([e.id]);B(t)&&(delete S[e.id],se(t,e))}function ce(t){var n=I[t.id];if(delete I[t.id],n){l._debug("Handling remote call response for",t,"with context",n);var i=n.timeout;i&&e.clearTimeout(i);var r=n.callback;if(B(r))return se(r,t),!0}return!1}function ue(e){l._debug("Transport failure handling",e),e.transport&&(n=e.transport),e.url&&n.setURL(e.url);var t,i=e.action,r=e.delay||0;switch(i){case"handshake":t=r,H("handshaking"),y=!0,G(function(){oe(s,a)},t);break;case"retry":te(r);break;case"none":ie(!0);break;default:throw"Unknown action "+i}}function le(e,t){ae(e),Z("/meta/handshake",e),Z("/meta/unsuccessful",e),W()&&(t.action="none"),l.onTransportFailure.call(l,e,t,ue)}function he(e,t){Z("/meta/connect",e),Z("/meta/unsuccessful",e),W()&&(t.action="none"),l.onTransportFailure.call(l,e,t,ue)}function fe(e){ie(!0),ae(e),Z("/meta/disconnect",e),Z("/meta/unsuccessful",e)}function de(e){var t=w[e.subscription];if(t)for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];i&&!i.listener&&(delete t[n],l._debug("Removed failed subscription",i))}ae(e),Z("/meta/subscribe",e),Z("/meta/unsuccessful",e)}function ge(e){ae(e),Z("/meta/unsubscribe",e),Z("/meta/unsuccessful",e)}function pe(e){ce(e)||(ae(e),Z("/meta/publish",e),Z("/meta/unsuccessful",e))}function me(e){var t,i,r,o;if(U=0,void 0!==(e=function(e){for(var t=0;t<k.length&&void 0!==e&&null!==e;++t){var n=q.reverseIncomingExtensions?k.length-1-t:t,i=k[n],r=i.extension.incoming;if(B(r)){var o=X(i.extension,r,i.name,e,!1);e=void 0===o?e:o}}return e}(e))&&null!==e)switch(ne(e.advice),e.channel){case"/meta/handshake":!function(e){var t=l.getURL();if(e.successful){var i=l._isCrossDomain(M(t)[2]),r=d.negotiateTransport(e.supportedConnectionTypes,e.version,i,t);if(null===r)return e.successful=!1,void le(e,{cause:"negotiation",action:"none",transport:null});n!==r&&(l._debug("Transport",n.getType(),"->",r.getType()),n=r),m=e.clientId,y=!1,ee(),e.reestablish=R,R=!0,ae(e),Z("/meta/handshake",e),E=e["x-messages"]||0;var o=W()?"none":C.reconnect||"retry";switch(o){case"retry":Y(),0===E?te(0):l._debug("Processing",E,"handshake-delivered messages");break;case"none":ie(!0);break;default:throw"Unrecognized advice action "+o}}else le(e,{cause:"unsuccessful",action:C.reconnect||"handshake",transport:n})}(e);break;case"/meta/connect":!function(e){if(L=e.successful){Z("/meta/connect",e);var t=W()?"none":C.reconnect||"retry";switch(t){case"retry":Y(),te(x);break;case"none":ie(!1);break;default:throw"Unrecognized advice action "+t}}else he(e,{cause:"unsuccessful",action:C.reconnect||"retry",transport:n})}(e);break;case"/meta/disconnect":(o=e).successful?(ie(!1),ae(o),Z("/meta/disconnect",o)):fe(o);break;case"/meta/subscribe":(r=e).successful?(ae(r),Z("/meta/subscribe",r)):de(r);break;case"/meta/unsubscribe":(i=e).successful?(ae(i),Z("/meta/unsubscribe",i)):ge(i);break;default:void 0!==(t=e).data?ce(t)||(Z(t.channel,t),E>0&&0==--E&&(l._debug("Processed last handshake-delivered message"),te(0))):void 0===t.successful?l._warn("Unknown Bayeux Message",t):t.successful?(ae(t),Z("/meta/publish",t)):pe(t)}}function ve(e){var t=w[e];if(t)for(var n in t)if(t.hasOwnProperty(n)&&t[n])return!0;return!1}function be(e,t){var n={scope:e,method:t};if(B(e))n.scope=void 0,n.method=e;else if(F(t)){if(!e)throw"Invalid scope "+e;if(n.method=e[t],!B(n.method))throw"Invalid callback "+t+" for scope "+e}else if(!B(t))throw"Invalid callback "+t;return n}function ye(e,t,n,i){var r=be(t,n);l._debug("Adding",i?"listener":"subscription","on",e,"with scope",r.scope,"and callback",r.method);var o=++T,s={id:o,channel:e,scope:r.scope,callback:r.method,listener:i},a=w[e];return a||(a={},w[e]=a),a[o]=s,l._debug("Added",i?"listener":"subscription",s),s}this._mixin=function(e,t,n){for(var i=t||{},r=2;r<arguments.length;++r){var o=arguments[r];if(void 0!==o&&null!==o)for(var s in o)if(o.hasOwnProperty(s)){var a=A(o,s),c=A(i,s);if(a===t)continue;if(void 0===a)continue;if(e&&"object"==typeof a&&null!==a)if(a instanceof Array)i[s]=this._mixin(e,c instanceof Array?c:[],a);else{var u="object"!=typeof c||c instanceof Array?{}:c;i[s]=this._mixin(e,u,a)}else i[s]=a}}return i},this._warn=function(){D("warn",arguments)},this._info=function(){"warn"!==q.logLevel&&D("info",arguments)},this._debug=function(){"debug"===q.logLevel&&D("debug",arguments)},this._isCrossDomain=function(e){return e&&e!==window.location.host},this.send=Q,this._getCallback=function(e){return S[e]},this._putCallback=function(e,t){var n=this._getCallback(e);return B(t)&&(S[e]=t),n},this.onTransportFailure=function(e,t,i){this._debug("Transport failure",t,"for",e);var r=this.getTransportRegistry(),o=this.getURL(),s=this._isCrossDomain(M(o)[2]),a=r.findTransportTypes("1.0",s,o);if("none"===t.action){if("/meta/handshake"===e.channel&&!t.transport){var c="Could not negotiate transport, client=["+a+"], server=["+e.supportedConnectionTypes+"]";this._warn(c),re(n.getType(),null,{reason:c,connectionType:n.getType(),transport:n})}}else if(t.delay=this.getBackoffPeriod(),"/meta/handshake"===e.channel){if(!t.transport){var u=r.negotiateTransport(a,"1.0",s,o);u?(this._debug("Transport",n.getType(),"->",u.getType()),re(n.getType(),u.getType(),e.failure),t.action="handshake",t.transport=u):(this._warn("Could not negotiate transport, client=["+a+"]"),re(n.getType(),null,e.failure),t.action="none")}"none"!==t.action&&this.increaseBackoffPeriod()}else{var h=(new Date).getTime();if(0===U&&(U=h),"retry"===t.action){t.delay=this.increaseBackoffPeriod();var f=C.maxInterval;if(f>0){var d=C.timeout+C.interval+f;h-U+x>d&&(t.action="handshake")}}"handshake"===t.action&&(t.delay=0,r.reset(!1),this.resetBackoffPeriod())}i.call(l,t)},this.receive=me,c=function(e){l._debug("Received",e);for(var t=0;t<e.length;++t)me(e[t])},u=function(e,t,n){l._debug("handleFailure",e,t,n),n.transport=e;for(var i=0;i<t.length;++i){var r=t[i],o={id:r.id,successful:!1,channel:r.channel,failure:n};switch(n.message=r,r.channel){case"/meta/handshake":le(o,{cause:"failure",action:"handshake",transport:null});break;case"/meta/connect":L=!1,he(o,{cause:"failure",action:"retry",transport:null});break;case"/meta/disconnect":fe(o);break;case"/meta/subscribe":o.subscription=r.subscription,de(o);break;case"/meta/unsubscribe":o.subscription=r.subscription,ge(o);break;default:pe(o)}}},this.registerTransport=function(e,t,n){var i=d.add(e,t,n);return i&&(this._debug("Registered transport",e),B(t.registered)&&t.registered(e,this)),i},this.unregisterTransport=function(e){var t=d.remove(e);return null!==t&&(this._debug("Unregistered transport",e),B(t.unregistered)&&t.unregistered()),t},this.unregisterTransports=function(){d.clear()},this.getTransportTypes=function(){return d.getTransportTypes()},this.findTransport=function(e){return d.find(e)},this.getTransportRegistry=function(){return d},this.configure=function(e){(function(e){l._debug("Configuring cometd object with",e),F(e)&&(e={url:e}),e||(e={}),q=l._mixin(!1,q,e);var t=l.getURL();if(!t)throw"Missing required configuration parameter 'url' specifying the Bayeux server URL";var n=M(t),i=n[2],r=n[8],o=n[9];if(f=l._isCrossDomain(i),q.appendMessageTypeToURL)if(void 0!==o&&o.length>0)l._info("Appending message type to URI "+r+o+" is not supported, disabling 'appendMessageTypeToURL' configuration"),q.appendMessageTypeToURL=!1;else{var s=r.split("/"),a=s.length-1;r.match(/\/$/)&&(a-=1),s[a].indexOf(".")>=0&&(l._info("Appending message type to URI "+r+" is not supported, disabling 'appendMessageTypeToURL' configuration"),q.appendMessageTypeToURL=!1)}}).call(this,e)},this.init=function(e,t){this.configure(e),this.handshake(t)},this.handshake=function(e,t){if("disconnected"!==g)throw"Illegal state: handshaken";oe(e,t)},this.disconnect=function(e,t,n){if(!W()){"boolean"!=typeof e&&(n=t,t=e,e=!1),B(t)&&(n=t,t=void 0);var i={id:J(),channel:"/meta/disconnect"},r=this._mixin(!1,{},t,i);l._putCallback(r.id,n),H("disconnecting"),K(!0===e,[r],!1,"disconnect")}},this.startBatch=function(){++v,l._debug("Starting batch, depth",v)},this.endBatch=function(){!function(){if(--v,l._debug("Ending batch, depth",v),v<0)throw"Calls to startBatch() and endBatch() are not paired";0!==v||W()||y||ee()}()},this.batch=function(e,t){var n=be(e,t);this.startBatch();try{n.method.call(n.scope),this.endBatch()}catch(e){throw this._info("Exception during execution of batch",e),this.endBatch(),e}},this.addListener=function(e,t,n){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!F(e))throw"Illegal argument type: channel must be a string";return ye(e,t,n,!0)},this.removeListener=function(e){if(!(e&&e.channel&&"id"in e))throw"Invalid argument: expected subscription, not "+e;O(e)},this.clearListeners=function(){w={}},this.subscribe=function(e,t,n,i,r){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!F(e))throw"Illegal argument type: channel must be a string";if(W())throw"Illegal state: disconnected";B(t)&&(r=i,i=n,n=t,t=void 0),B(i)&&(r=i,i=void 0);var o=!ve(e),s=ye(e,t,n,!1);if(o){var a={id:J(),channel:"/meta/subscribe",subscription:e},c=this._mixin(!1,{},i,a);l._putCallback(c.id,r),Q(c)}return s},this.unsubscribe=function(e,t,n){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(W())throw"Illegal state: disconnected";B(t)&&(n=t,t=void 0),this.removeListener(e);var i=e.channel;if(!ve(i)){var r={id:J(),channel:"/meta/unsubscribe",subscription:i},o=this._mixin(!1,{},t,r);l._putCallback(o.id,n),Q(o)}},this.resubscribe=function(e,t){if(N(e),e)return this.subscribe(e.channel,e.scope,e.callback,t)},this.clearSubscriptions=function(){j()},this.publish=function(e,t,n,i){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(!F(e))throw"Illegal argument type: channel must be a string";if(/^\/meta\//.test(e))throw"Illegal argument: cannot publish to meta channels";if(W())throw"Illegal state: disconnected";B(t)?(i=t,t={},n=void 0):B(n)&&(i=n,n=void 0);var r={id:J(),channel:e,data:t},o=this._mixin(!1,{},n,r);l._putCallback(o.id,i),Q(o)},this.publishBinary=function(e,t,n,i,r){B(t)?(r=t,t=new ArrayBuffer(0),n=!0,i=void 0):B(n)?(r=n,n=!0,i=void 0):B(i)&&(r=i,i=void 0);var o={meta:i,data:t,last:n};this.publish(e,o,{ext:{binary:{}}},r)},this.remoteCall=function(t,n,i,r,o){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(!F(t))throw"Illegal argument type: target must be a string";if(W())throw"Illegal state: disconnected";if(B(n)?(o=n,n={},i=q.maxNetworkDelay,r=void 0):B(i)?(o=i,i=q.maxNetworkDelay,r=void 0):B(r)&&(o=r,r=void 0),"number"!=typeof i)throw"Illegal argument type: timeout must be a number";t.match(/^\//)||(t="/"+t);var s="/service"+t,a={id:J(),channel:s,data:n},c=this._mixin(!1,{},r,a),u={callback:o};i>0&&(u.timeout=e.setTimeout(l,function(){l._debug("Timing out remote call",c,"after",i,"ms"),pe({id:c.id,error:"406::timeout",successful:!1,failure:{message:c,reason:"Remote Call Timeout"}})},i),l._debug("Scheduled remote call timeout",c,"in",i,"ms")),I[c.id]=u,Q(c)},this.remoteCallBinary=function(e,t,n,i,r,o){B(t)?(o=t,t=new ArrayBuffer(0),n=!0,i=void 0,r=q.maxNetworkDelay):B(n)?(o=n,n=!0,i=void 0,r=q.maxNetworkDelay):B(i)?(o=i,i=void 0,r=q.maxNetworkDelay):B(r)&&(o=r,r=q.maxNetworkDelay);var s={meta:i,data:t,last:n};this.remoteCall(e,s,r,{ext:{binary:{}}},o)},this.getStatus=function(){return g},this.isDisconnected=W,this.setBackoffIncrement=function(e){q.backoffIncrement=e},this.getBackoffIncrement=function(){return q.backoffIncrement},this.getBackoffPeriod=function(){return x},this.increaseBackoffPeriod=function(){return x<q.maxBackoff&&(x+=q.backoffIncrement),x},this.resetBackoffPeriod=function(){Y()},this.setLogLevel=function(e){q.logLevel=e},this.registerExtension=function(e,t){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!F(e))throw"Illegal argument type: extension name must be a string";for(var n=!1,i=0;i<k.length;++i)if(k[i].name===e){n=!0;break}return n?(this._info("Could not register extension with name",e,"since another extension with the same name already exists"),!1):(k.push({name:e,extension:t}),this._debug("Registered extension",e),B(t.registered)&&t.registered(e,this),!0)},this.unregisterExtension=function(e){if(!F(e))throw"Illegal argument type: extension name must be a string";for(var t=!1,n=0;n<k.length;++n){var i=k[n];if(i.name===e){k.splice(n,1),t=!0,this._debug("Unregistered extension",e);var r=i.extension;B(r.unregistered)&&r.unregistered();break}}return t},this.getExtension=function(e){for(var t=0;t<k.length;++t){var n=k[t];if(n.name===e)return n.extension}return null},this.getName=function(){return h},this.getClientId=function(){return m},this.getURL=function(){if(n){var e=n.getURL();if(e)return e;if(e=q.urls[n.getType()])return e}return q.url},this.getTransport=function(){return n},this.getConfiguration=function(){return this._mixin(!0,{},q)},this.getAdvice=function(){return this._mixin(!0,{},C)},window.WebSocket&&this.registerTransport("websocket",new o),this.registerTransport("long-polling",new i),this.registerTransport("callback-polling",new r)},Transport:t,RequestTransport:n,LongPollingTransport:i,CallbackPollingTransport:r,WebSocketTransport:o,Utils:e,Z85:{encode:function(e){var t=null;if(e instanceof ArrayBuffer?t=e:e.buffer instanceof ArrayBuffer?t=e.buffer:Array.isArray(e)&&(t=new Uint8Array(e).buffer),null==t)throw"Cannot Z85 encode "+e;for(var n=t.byteLength,i=n%4,r=4-(0===i?4:i),o=new DataView(t),a="",c=0,u=0;u<n+r;++u){var l=u>=n;if(c=256*c+(l?0:o.getUint8(u)),(u+1)%4==0){for(var h=52200625,f=5;f>0;--f){if(!l||f>r){var d=Math.floor(c/h)%85;a+=s[d]}h/=85}c=0}}return a},decode:function(e){for(var t=e.length%5,n=5-(0===t?5:t),i=0;i<n;++i)e+=s[s.length-1];for(var r=e.length,o=new ArrayBuffer(4*r/5-n),c=new DataView(o),u=0,l=0,h=0,f=0;f<r;++f){var d=e.charCodeAt(l++)-32;if(u=85*u+a[d],l%5==0){for(var g=16777216;g>=1;)h<c.byteLength&&c.setUint8(h++,Math.floor(u/g)%256),g/=256;u=0}}return o}}}});