/*
 * Copyright (c) 2008-2017 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

!function(e,n){"object"==typeof exports?module.exports=n(require("./cometd")):"function"==typeof define&&define.amd?define(["./cometd"],n):n(e.org.cometd)}(this,function(e){return e.ReloadExtension=function(e){var n,t,o={},s="org.cometd.reload",a=!1,r=!1;function i(e){if(o.handshakeResponse){r=!0;var a=n.getTransport();a&&a.abort(),d(e);var i=JSON.stringify(o);t("Reload extension saving state",i),window.sessionStorage.setItem(s,i)}}function d(e){e&&"string"==typeof e.name&&(s=e.name)}this.configure=d,this._receive=function(e){n.receive(e)},this.registered=function(e,o){(n=o).reload=i,t=n._debug},this.unregistered=function(){delete n.reload,n=null},this.outgoing=function(e){switch(e.channel){case"/meta/handshake":(o={}).url=n.getURL();var i=window.sessionStorage.getItem(s);if(t("Reload extension found state",i),i)try{var d=JSON.parse(i);if(window.sessionStorage.removeItem(s),d.handshakeResponse&&(p=d,o.url==p.url)){t("Reload extension restoring state",d);var c=n._getCallback(e.id),h=this;return setTimeout(function(){t("Reload extension replaying handshake response",d.handshakeResponse),o.handshakeResponse=d.handshakeResponse,o.transportType=d.transportType,n._putCallback(e.id,c);var s=n._mixin(!0,{},o.handshakeResponse,{id:e.id,ext:{reload:!0}});s.supportedConnectionTypes=[o.transportType],h._receive(s),t("Reload extension replayed handshake response",s)},0),a||(a=!0,n.startBatch()),null}t("Reload extension could not restore state",d)}catch(e){t("Reload extension error while trying to restore state",e)}break;case"/meta/connect":if(!0===r)return t("Reload extension aborting /meta/connect during reload"),null;o.transportType||(o.transportType=e.connectionType,t("Reload extension tracked transport type",o.transportType));break;case"/meta/disconnect":o={}}var p;return e},this.incoming=function(e){if(e.successful)switch(e.channel){case"/meta/handshake":o.handshakeResponse||(o.handshakeResponse=e,t("Reload extension tracked handshake response",e));break;case"/meta/connect":a&&(a=!1,n.endBatch());break;case"/meta/disconnect":o={}}return e},d(e)}});